<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style_th.css">
    <title>Panel de Administración</title>
    <style>
        body {
            display: flex;
            font-family: Arial, sans-serif;
            margin: 0;
            width: 100%;
            background-color: rgb(240, 225, 225);
            padding: 20px;
            box-shadow: 0 0 30px rgb(25, 110, 10);
            background-size: cover;
            background-position: center;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 20px;
        }

        .sidebar {
            width: 100px;
            height: 100vh;
            background-color: #30425c;
            padding: 15px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        .sidebar button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
        }

        .sidebar button:hover {
            background-color: #0056b3;
            padding: 13px;
        }

        .content {
            padding: 20px;
            overflow-x: auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            max-width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid rgb(7, 69, 20);
        }

        th {
            background-color: #343a40;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
        }

        td {
            color: rgb(2, 0, 9);
        }

        .total-info {
            margin-bottom: 20px;
        }

        .total-info span {
            font-weight: bold;
        }

        @media screen and (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                width: 100%;
                height: auto;
                box-shadow: none;
            }

            .sidebar button {
                width: auto;
                margin: 5px;
            }

            .content {
                padding: 10px;
            }

            th,
            td {
                font-size: 14px;
                padding: 10px;
            }
        }

        @media screen and (max-width: 480px) {

            th,
            td {
                font-size: 12px;
                padding: 8px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="sidebar">
            <button id="btnRegresar">Regresar</button>
            <button id="btnInicio">Inicio</button>
            <button id="btnEliminarTodo">Eliminar Todo</button>
            <button id="btnDescargarTodo">Descargar Todo</button>
        </div>
        <div class="content">
            <h1>Panel de Administración de Formularios</h1>
            <div class="total-info">
                <span>Total de Registros:</span> <span id="totalRegistros">0</span>
            </div>
            <section>
                <table id="formTable">
                    <thead>
                        <tr>
                            <th>Fecha Creación</th>
                            <th>Tipo Solicitud</th>
                            <th>Nombre</th>
                            <th>Teléfono</th>
                            <th>Correo</th>
                            <th>Fecha Última Visita USA</th>
                            <th>Duración en USA</th>
                            <th>Cantidad Días/Meses</th>
                            <th>Imagen Frente</th>
                            <th>Imagen Reverso</th>
                            <th>Acta de Nacimiento</th>
                            <th>Pasaporte</th>
                            <th>INE</th>
                            <th>Archivo</th>
                            <th>Apellido Paterno</th>
                            <th>Apellido Materno</th>
                            <th>Nombres</th>
                            <th>Fecha Nacimiento</th>
                            <th>Sexo</th>
                            <th>Lugar Nacimiento</th>
                            <th>Estado Civil</th>
                            <th>Nombre Cónyuge</th>
                            <th>Fecha Nacimiento Cónyuge</th>
                            <th>Lugar Nacimiento Cónyuge</th>
                            <th>Escolaridad</th>
                            <th>Nombre Escuela</th>
                            <th>Dirección Escuela</th>
                            <th>Fecha Inicio Escuela</th>
                            <th>Fecha Final Escuela</th>
                            <th>Ocupación Actual</th>
                            <th>Nombre Empresa Actual</th>
                            <th>Domicilio Empresa Actual</th>
                            <th>Fecha Inicio Empleo Actual</th>
                            <th>Teléfono Empresa Actual</th>
                            <th>Salario Mensual</th>
                            <th>Nombre Empresa Anterior</th>
                            <th>Domicilio Empresa Anterior</th>
                            <th>Fecha Inicio Empleo Anterior</th>
                            <th>Fecha Fin Empleo Anterior</th>
                            <th>Nombre Jefe Inmediato</th>
                            <th>Nombre Completo Padre</th>
                            <th>Fecha Nacimiento Padre</th>
                            <th>Padre Vive en USA</th>
                            <th>Nombre Completo Madre</th>
                            <th>Fecha Nacimiento Madre</th>
                            <th>Madre Vive en USA</th>
                            <th>Facebook</th>
                            <th>Instagram</th>
                            <th>Sitio Web</th>
                            <th>Familiares en USA</th>
                            <th>Nombre Familiar Cercano</th>
                            <th>Teléfono Familiar Cercano</th>
                            <th>Domicilio Familiar Cercano</th>
                            <th>Visa Anterior</th>
                            <th>Descripción Procedimiento</th>
                            <th>Visitas a USA</th>
                            <th>Fecha Visita a USA</th>
                            <th>Viajes al Extranjero Últimos 5 Años</th>
                            <th>País</th>
                            <th>Domina Inglés</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Aquí se llenarán los datos de los formularios -->
                    </tbody>
                </table>
            </section>
        </div>
    </div>
</body>




<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, collection, getDocs, deleteDoc, doc, updateDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js';

    // Configuración de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyB2YHOPydtFOFn5Sr3PXNp6H-6TM0p3Urc",
        authDomain: "tramitesvisa-itzel.firebaseapp.com",
        projectId: "tramitesvisa-itzel",
        storageBucket: "tramitesvisa-itzel.appspot.com",
        messagingSenderId: "356859229057",
        appId: "1:356859229057:web:ab3b905aaacfa2d2b86e80"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    async function loadFormData() {
        try {
            const querySnapshot = await getDocs(collection(db, 'formularios'));
            const tableBody = document.getElementById('formTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';  // Limpia el contenido de la tabla
            let totalRecords = 0;

            querySnapshot.forEach(async (doc) => {
                const data = doc.data();
                const row = tableBody.insertRow();  // Inserta una nueva fila en la tabla

                row.insertCell(0).textContent = data.fecha_hora || '';
                row.insertCell(1).textContent = data.tipo_solicitud || '';
                row.insertCell(2).textContent = data.nombre || '';
                row.insertCell(3).textContent = data.telefono || '';
                row.insertCell(4).textContent = data.correo || '';

                row.insertCell(5).textContent = data.fecha_ultimavisita_usa || '';
                row.insertCell(6).textContent = data.duracion_en_usa || '';
                row.insertCell(7).textContent = data.cantidad_dias_meses || '';



                // Datos Personales
                row.insertCell(8).textContent = data.apellido_paterno || '';
                row.insertCell(9).textContent = data.apellido_materno || '';
                row.insertCell(10).textContent = data.nombres || '';
                row.insertCell(11).textContent = data.fecha_nacimiento || '';
                row.insertCell(12).textContent = data.sexo || '';
                row.insertCell(13).textContent = data.lugar_nacimiento || '';
                // Estado Civil
                row.insertCell(14).textContent = data.estado_civil || '';

                // Datos de Cónyuge (solo si está visible)
                row.insertCell(15).textContent = data.nombre_completo_conyuge || '';
                row.insertCell(16).textContent = data.fecha_nacimiento_conyuge || '';
                row.insertCell(17).textContent = data.lugar_nacimiento_conyuge || '';

                // Datos Académicos
                row.insertCell(18).textContent = data.escolaridad || '';
                row.insertCell(19).textContent = data.nombre_escuela || '';
                row.insertCell(20).textContent = data.direccion_escuela || '';
                row.insertCell(21).textContent = data.fecha_inicio_escuela || '';
                row.insertCell(22).textContent = data.fecha_final_escuela || '';

                // Empleo Actual
                row.insertCell(23).textContent = data.ocupacion_actual_empleo || '';
                row.insertCell(24).textContent = data.nombre_empresa_actual || '';
                row.insertCell(25).textContent = data.domicilio_empresas_actual || '';
                row.insertCell(26).textContent = data.fecha_inicio_empleo_actual || '';
                row.insertCell(27).textContent = data.telefono_empres_actual || '';
                row.insertCell(28).textContent = data.salario_ensual_empleo_actual || '';

                // Empleo Anterior
                row.insertCell(29).textContent = data.nombre_empresa_anterior || '';
                row.insertCell(30).textContent = data.domicilio_empresas_anterior || '';
                row.insertCell(31).textContent = data.fecha_inicio_empleo_anterior || '';
                row.insertCell(32).textContent = data.fecha_fin_empleo_anterior || '';
                row.insertCell(33).textContent = data.nombre_jefe_inmediato || '';

                // Datos de los Padres
                row.insertCell(34).textContent = data.nombre_completo_padre || '';
                row.insertCell(35).textContent = data.fecha_nacimiento_padre || '';
                row.insertCell(36).textContent = data.padre_vive_estados_unidos || '';
                row.insertCell(37).textContent = data.nombre_completo_madre || '';
                row.insertCell(38).textContent = data.fecha_nacimiento_madre || '';
                row.insertCell(39).textContent = data.madre_vive_estados_unidos || '';

                // Redes Sociales
                row.insertCell(40).textContent = data.facebook || '';
                row.insertCell(41).textContent = data.instagram || '';
                row.insertCell(42).textContent = data.sitio_web || '';

                // Información Adicional
                row.insertCell(43).textContent = data.tiene_familiares_estados_unidos || '';
                row.insertCell(44).textContent = data.nombre_completo_familiar_cercano || '';
                row.insertCell(45).textContent = data.numero_telefonico_familiar_cercano || '';
                row.insertCell(46).textContent = data.domicilio_familiar_cercano || '';
                row.insertCell(47).textContent = data.tramitaron_visa_antes || '';
                row.insertCell(48).textContent = data.redacta_procedimiento_realizado || '';
                row.insertCell(49).textContent = data.han_visitado_estados_unidos || '';
                row.insertCell(50).textContent = data.fecha_visita_estados_unidos || '';
                row.insertCell(51).textContent = data.han_viajado_extranjero_últimos_cinco_años || '';
                row.insertCell(52).textContent = data.pais || '';
                row.insertCell(53).textContent = data.domina_ingles || '';



                // Manejo de imágenes
                const imgFrontCell = row.insertCell(8);
                if (data.foto1URL) {
                    try {
                        const imgFrontRef = ref(storage, data.foto1URL);
                        const imgFrontURL = await getDownloadURL(imgFrontRef);
                        const imgFrontLink = document.createElement('a');
                        imgFrontLink.href = imgFrontURL;
                        imgFrontLink.textContent = 'Ver Imagen Frente';
                        imgFrontLink.target = '_blank';
                        imgFrontCell.appendChild(imgFrontLink);
                    } catch (error) {
                        imgFrontCell.textContent = 'Imagen no disponible';
                        console.error('Error al obtener la URL de la imagen frente:', error);
                    }
                } else {
                    imgFrontCell.textContent = 'Imagen no disponible';
                }

                const imgBackCell = row.insertCell(9);
                if (data.foto2URL) {
                    try {
                        const imgBackRef = ref(storage, data.foto2URL);
                        const imgBackURL = await getDownloadURL(imgBackRef);
                        const imgBackLink = document.createElement('a');
                        imgBackLink.href = imgBackURL;
                        imgBackLink.textContent = 'Ver Imagen Reverso';
                        imgBackLink.target = '_blank';
                        imgBackCell.appendChild(imgBackLink);
                    } catch (error) {
                        imgBackCell.textContent = 'Imagen no disponible';
                        console.error('Error al obtener la URL de la imagen reverso:', error);
                    }
                } else {
                    imgBackCell.textContent = 'Imagen no disponible';
                }

                const birthActCell = row.insertCell(10);
                if (data.foto3URL) {
                    try {
                        const birthActRef = ref(storage, data.foto3URL);
                        const birthActURL = await getDownloadURL(birthActRef);
                        const birthActLink = document.createElement('a');
                        birthActLink.href = birthActURL;
                        birthActLink.textContent = 'Ver Acta de Nacimiento';
                        birthActLink.target = '_blank';
                        birthActCell.appendChild(birthActLink);
                    } catch (error) {
                        birthActCell.textContent = 'Acta no disponible';
                        console.error('Error al obtener la URL del acta de nacimiento:', error);
                    }
                } else {
                    birthActCell.textContent = 'Acta no disponible';
                }

                const passportCell = row.insertCell(11);
                if (data.foto4URL) {
                    try {
                        const passportRef = ref(storage, data.foto4URL);
                        const passportURL = await getDownloadURL(passportRef);
                        const passportLink = document.createElement('a');
                        passportLink.href = passportURL;
                        passportLink.textContent = 'Ver Pasaporte';
                        passportLink.target = '_blank';
                        passportCell.appendChild(passportLink);
                    } catch (error) {
                        passportCell.textContent = 'Pasaporte no disponible';
                        console.error('Error al obtener la URL del pasaporte:', error);
                    }
                } else {
                    passportCell.textContent = 'Pasaporte no disponible';
                }

                const ineCell = row.insertCell(12);
                if (data.foto5URL) {
                    try {
                        const ineRef = ref(storage, data.foto5URL);
                        const ineURL = await getDownloadURL(ineRef);
                        const ineLink = document.createElement('a');
                        ineLink.href = ineURL;
                        ineLink.textContent = 'Ver INE';
                        ineLink.target = '_blank';
                        ineCell.appendChild(ineLink);
                    } catch (error) {
                        ineCell.textContent = 'INE no disponible';
                        console.error('Error al obtener la URL del INE:', error);
                    }
                } else {
                    ineCell.textContent = 'INE no disponible';
                }

                const fileCell = row.insertCell(13);
                if (data.archivoURL) {
                    try {
                        const fileRef = ref(storage, data.archivoURL);
                        const fileURL = await getDownloadURL(fileRef);
                        const fileLink = document.createElement('a');
                        fileLink.href = fileURL;
                        fileLink.textContent = 'Ver Archivo';
                        fileLink.target = '_blank';
                        fileCell.appendChild(fileLink);
                    } catch (error) {
                        fileCell.textContent = 'Archivo no disponible';
                        console.error('Error al obtener la URL del archivo:', error);
                    }
                } else {
                    fileCell.textContent = 'Archivo no disponible';
                }

                totalRecords++;
                document.getElementById('totalRegistros').textContent = totalRecords;
            });



            document.getElementById('totalRegistros').textContent = totalRecords;
        } catch (error) {
            console.error('Error al cargar los datos:', error);
            alert('No se pudo cargar los datos. Verifica la consola para más detalles.');
        }
        // Ordenar datos por fecha de última visita
        sortTable();
    }



    async function eliminarTodo() {
        try {
            const querySnapshot = await getDocs(collection(db, 'formularios'));
            const batch = writeBatch(db);
            querySnapshot.forEach((doc) => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            alert('Todos los registros han sido eliminados.');
            loadFormData();  // Recargar los datos después de eliminar
        } catch (error) {
            console.error('Error al eliminar los datos:', error);
            alert('No se pudo eliminar los registros. Verifica la consola para más detalles.');
        }
    }

    function descargarTodo() {
        const table = document.getElementById('formTable');
        const wb = XLSX.utils.table_to_book(table, { sheet: "Datos" });
        XLSX.writeFile(wb, 'datos_formularios.xlsx');
    }

    document.getElementById('btnRegresar').addEventListener('click', () => window.location.href = 'admin.html');
    document.getElementById('btnInicio').addEventListener('click', () => window.location.href = 'index.html');
    document.getElementById('btnEliminarTodo').addEventListener('click', eliminarTodo);
    document.getElementById('btnDescargarTodo').addEventListener('click', descargarTodo);

    window.onload = loadFormData;
</script>
</body>

</html>